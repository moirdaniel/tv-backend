name: Deploy TV Backend

on:
  push:
    branches:
      - Serv01

jobs:
  deploy:
    name: Despliegue directo con Dockerfile
    runs-on: self-hosted

    steps:
    - name: Clonar c√≥digo desde GitHub privado
      run: |
        echo "${{ secrets.DMOIR_SUDO_PASSWORD }}" | sudo -S rm -rf /tmp/tv-backend
        git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/moirdaniel/tv-backend.git /tmp/tv-backend

    - name: Detener contenedor anterior si existe
      run: |
        echo "${{ secrets.DMOIR_SUDO_PASSWORD }}" | sudo -S docker stop tv-backend || true
        echo "${{ secrets.DMOIR_SUDO_PASSWORD }}" | sudo -S docker rm tv-backend || true

    - name: Construir imagen desde Dockerfile
      run: |
        cd /tmp/tv-backend
        echo "${{ secrets.DMOIR_SUDO_PASSWORD }}" | sudo -S docker build -t tv-backend:latest .

    - name: Iniciar contenedor
      run: |
        echo "${{ secrets.DMOIR_SUDO_PASSWORD }}" | sudo -S docker run -d \
          --name tv-backend \
          -p 3000:3000 \
          -v /tmp/tv-backend:/app \
          tv-backend:latest
